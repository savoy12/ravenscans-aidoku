name: Build & Publish Aidoku Source

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
          override: true

      - name: Build WASM
        working-directory: sources/ravenscans
        run: |
          rustup target add wasm32-unknown-unknown
          cargo build --release --target wasm32-unknown-unknown
          mkdir -p ../../dist/ravenscans
          cp target/wasm32-unknown-unknown/release/ravenscans.wasm ../../dist/ravenscans/source.wasm
          cp aidoku.json ../../dist/ravenscans/aidoku.json
          cd ../../dist/ravenscans
          zip -9 ../../ravenscans.aix aidoku.json source.wasm

      - name: Prepare gh-pages content
        run: |
          mkdir -p public/sources
          cp dist/ravenscans/aidoku.json public/sources/com.ravenscans.json
          cp dist/ravenscans/source.wasm public/sources/com.ravenscans.wasm
          cp ravenscans.aix public/sources/com.ravenscans.aix
          cat > public/repo.json << 'EOF'
          {
            "name": "RavenScans Source",
            "sources": [
              {
                "id": "com.ravenscans",
                "name": "RavenScans",
                "lang": "en",
                "nsfw": true,
                "version": 1,
                "aix": "sources/com.ravenscans.aix"
              }
            ]
          }
          EOF

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
